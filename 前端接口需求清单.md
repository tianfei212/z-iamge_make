# 前端接口需求清单

## 1. 页面功能分析（基于现有前端实现）

- **模型初始化与选择**
  - 页面加载后拉取模型列表并默认选中第一个模型：
    - [App.tsx:L49-L66](file:///home/ubuntu/codes/z_image_make/App.tsx#L49-L66)
    - [models_controller.py:L16-L18](file:///home/ubuntu/codes/z_image_make/backend/controllers/models_controller.py#L16-L18)
- **提示词编辑**
  - 支持编辑“通用基础主体”与“当前编辑分类”的提示词：
    - [App.tsx:L193-L269](file:///home/ubuntu/codes/z_image_make/App.tsx#L193-L269)
  - 点击分类标签切换编辑分类并控制是否参与批量生产：
    - [App.tsx:L90-L99](file:///home/ubuntu/codes/z_image_make/App.tsx#L90-L99)
    - [App.tsx:L234-L248](file:///home/ubuntu/codes/z_image_make/App.tsx#L234-L248)
  - 支持添加自定义分类：
    - [App.tsx:L100-L114](file:///home/ubuntu/codes/z_image_make/App.tsx#L100-L114)
- **中英互译**
  - 通用主体与分类提示词都可触发“中英互译”按钮，调用后端翻译接口：
    - [App.tsx:L72-L88](file:///home/ubuntu/codes/z_image_make/App.tsx#L72-L88)
    - [geminiService.ts:L7-L22](file:///home/ubuntu/codes/z_image_make/services/geminiService.ts#L7-L22)
    - [translate_controller.py:L16-L22](file:///home/ubuntu/codes/z_image_make/backend/controllers/translate_controller.py#L16-L22)
- **批量生产任务流**
  - 按“启动批量生产”后，按“分类 × 每类数量”串行循环生成（每张图一次请求），并更新进度与日志：
    - [App.tsx:L140-L176](file:///home/ubuntu/codes/z_image_make/App.tsx#L140-L176)
    - [geminiService.ts:L24-L77](file:///home/ubuntu/codes/z_image_make/services/geminiService.ts#L24-L77)
  - “紧急停止作业”仅停止后续循环，不会中断正在进行的那一次网络请求：
    - [App.tsx:L310-L314](file:///home/ubuntu/codes/z_image_make/App.tsx#L310-L314)
- **结果展示与导出**
  - 结果以网格卡片展示，支持“查看原图”（新标签打开 url）：
    - [ImageCard.tsx:L7-L34](file:///home/ubuntu/codes/z_image_make/components/ImageCard.tsx#L7-L34)
  - “打包下载”在前端将所有图片按分类打 zip（依赖图片 URL 为 dataURL 才能 base64 拆分）：
    - [App.tsx:L116-L138](file:///home/ubuntu/codes/z_image_make/App.tsx#L116-L138)

## 2. 接口需求清单（前端实际调用为准）

### 2.1 获取模型列表

- **用途**：下拉选择模型，决定后续生成走哪个服务（wan / z_image）
  - [App.tsx:L49-L66](file:///home/ubuntu/codes/z_image_make/App.tsx#L49-L66)
- **请求**
  - `GET /api/models`
  - 实现：
    - [models_controller.py:L16-L18](file:///home/ubuntu/codes/z_image_make/backend/controllers/models_controller.py#L16-L18)
- **响应（200）**
  - `{"models": ModelInfo[]}`
  - ModelInfo 结构（前端定义）：
    - [types.ts:L17-L23](file:///home/ubuntu/codes/z_image_make/types.ts#L17-L23)
    - 字段：`id` / `name` / `provider` / `modelName` / `description`
- **错误响应（建议）**
  - `>=400`: `{"status":"error","message":string}`

### 2.2 中英互译

- **用途**：翻译通用主体 / 分类提示词
  - [App.tsx:L72-L88](file:///home/ubuntu/codes/z_image_make/App.tsx#L72-L88)
- **请求**
  - `POST /api/translate`
  - `Content-Type: application/json`
  - Body：`{"text": string}`
  - 前端实现：
    - [geminiService.ts:L10-L14](file:///home/ubuntu/codes/z_image_make/services/geminiService.ts#L10-L14)
  - 后端实现：
    - [translate_controller.py:L16-L22](file:///home/ubuntu/codes/z_image_make/backend/controllers/translate_controller.py#L16-L22)
- **响应（200）**
  - `{"status":"success","output": string}`
  - 前端取值逻辑：
    - [geminiService.ts:L15-L18](file:///home/ubuntu/codes/z_image_make/services/geminiService.ts#L15-L18)
- **错误响应（建议）**
  - `>=400`: `{"status":"error","message":string,"code"?:number}`
  - 说明：前端当前读取 `data?.message`，若返回为 FastAPI 默认 `{"detail":...}` 会退化为通用报错文本：
    - [geminiService.ts:L15-L17](file:///home/ubuntu/codes/z_image_make/services/geminiService.ts#L15-L17)

### 2.3 图片生成（支持按数量批量生成）

- **用途**：前端按“分类 × 每类数量”发起生成
  - [App.tsx:L140-L176](file:///home/ubuntu/codes/z_image_make/App.tsx#L140-L176)
- **请求**
  - `POST /api/generate`
  - `Content-Type: application/json`
  - Body（前端实际发送）：
    - `service: "wan" | "z_image"`
    - `model: string`
    - `prompt: string`
    - `negative_prompt: string`
    - `size: string`（例如 `1280*720`）
    - `count: number`（本次需要生成的张数）
  - 前端实现：
    - [geminiService.ts:L55-L68](file:///home/ubuntu/codes/z_image_make/services/geminiService.ts#L55-L68)
    - service 推断规则：
      - [geminiService.ts:L79-L83](file:///home/ubuntu/codes/z_image_make/services/geminiService.ts#L79-L83)
    - size 映射规则：
      - [geminiService.ts:L85-L94](file:///home/ubuntu/codes/z_image_make/services/geminiService.ts#L85-L94)
  - 后端实现：
    - [generate_controller.py:L18-L57](file:///home/ubuntu/codes/z_image_make/backend/controllers/generate_controller.py#L18-L57)
  - Body（后端已支持但前端当前未发送/未使用）：
    - `category?: string`
    - `prompt_extend?: boolean`
- **响应（200）**
  - `count=1`：`{"status":"success","url": string}`
  - `count>1`：`{"status":"success","urls": string[], "count": number}`
  - 重要：为了兼容前端 zip 打包逻辑，`url/urls` 需要是 `data:<mime>;base64,...`（前端用 `img.url.split(',')[1]`）：
    - [App.tsx:L121-L126](file:///home/ubuntu/codes/z_image_make/App.tsx#L121-L126)
- **错误响应（建议）**
  - `>=400`: `{"status":"error","message":string,"code"?:number}`
  - 说明：前端当前读取 `data?.message`：
    - [geminiService.ts:L69-L71](file:///home/ubuntu/codes/z_image_make/services/geminiService.ts#L69-L71)

### 2.4 健康检查（非前端必需，但建议保留）

- `GET /health` → `{"status":"ok"}`
  - [health_controller.py:L14-L16](file:///home/ubuntu/codes/z_image_make/backend/controllers/health_controller.py#L14-L16)

### 2.5 历史图片缩略图加载

- **用途**：前端启动时从后端拉取已生成图片的缩略图并展示
- **请求**
  - `GET /api/images?category?:string&limit?:number&offset?:number`
- **响应（200）**
  - `{"images": Array<{id, category, filename, timestamp, originalUrl, thumbUrl}>}`
  - 说明：
    - `thumbUrl` 用于列表/瀑布流展示
    - `originalUrl` 用于“查看原图”
- **图片内容**
  - `GET /api/images/{id}/thumb?size=512`：返回缩略图（默认 jpeg）
  - `GET /api/images/{id}/raw`：返回原图

## 3. 特殊要求（对接/实现约束）

- **返回图片格式约束**：`/api/generate` 的 `url` 必须可直接用于 `<img src=...>` 且可被前端按 `dataURL` 方式打包：
  - [App.tsx:L121-L126](file:///home/ubuntu/codes/z_image_make/App.tsx#L121-L126)
- **长耗时请求**：单次生成可能较长；后端轮询任务最长 600s，接口需允许长连接并给出明确超时错误：
  - [dashscope_client_service.py:L191-L223](file:///home/ubuntu/codes/z_image_make/backend/services/dashscope_client_service.py#L191-L223)
- **高频批量调用**：批量生产会产生大量连续请求；建议后端对 429/5xx 给出可读 `message`，必要时提供 `Retry-After` 以便未来做重试退避。
- **参数校验与安全**：`service` 必须在允许集合内、`size` 需符合模型限制；API Key 只能在后端配置/环境变量中，任何响应不得回传密钥信息：
  - [generate_request_model.py:L16-L26](file:///home/ubuntu/codes/z_image_make/backend/models/generate_request_model.py#L16-L26)
  - [settings.py:L38-L79](file:///home/ubuntu/codes/z_image_make/backend/config/settings.py#L38-L79)
- **错误结构统一**：前端当前按 `data?.message` 取错因；建议所有接口在非 2xx 时统一返回顶层 `message` 字段，避免 FastAPI 默认 `detail` 造成信息丢失：
  - [geminiService.ts:L15-L17](file:///home/ubuntu/codes/z_image_make/services/geminiService.ts#L15-L17)
  - [geminiService.ts:L69-L71](file:///home/ubuntu/codes/z_image_make/services/geminiService.ts#L69-L71)
