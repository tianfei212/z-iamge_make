## 重要前提（ID 对齐）
- 前端传给后端的 ID 即“文件名称”。
- 后端详情接口将“优先支持文件名”查询；同时兼容现有的 image_id（如存在 base64 编码的相对路径）。
- 建议前端在调用详情时同时传递 category 与 filename，可使后端直接定位到 "category/filename"，避免全局搜索。

## 前端实现
- 触发点：在画廊的缩略图点击回调上，打开“图片详情模态框”。参考 [GalleryPage.tsx](file:///home/ubuntu/codes/z_image_make/pages/GalleryPage.tsx#L27-L33) 与 [App.tsx](file:///home/ubuntu/codes/z_image_make/App.tsx#L196-L201)。
- 新增组件：components/ImageDetailModal.tsx
  - 左侧内容区：展示 refined_positive、refined_negative，并辅以 base_prompt、category_prompt。支持长文本换行、复制操作。
  - 右侧图片区：原图自适应显示，支持缩放（0.5x–4x）、拖动、双击复位。
  - 布局：桌面端左右 1:2；移动端上下堆叠，分别独立滚动。
- 数据交互：
  - 新增服务方法 getImageDetails({ filename, category? })；优先以 filename+category 请求详情；若无 category 仅传 filename，后端将执行文件名搜索。
  - 打开模态框时发起加载；加载中显示 spinner；失败使用 Toast 提示并提供重试。
- 兼容现有行为：在详情视图中保留“在新标签打开原图”。参考 [ImageCard.tsx](file:///home/ubuntu/codes/z_image_make/components/ImageCard.tsx#L27-L32)。

## 后端 API（文件名优先）
- 新增：GET /api/images/by-filename/{filename}/details?category=...
  - 输入：路径参数 filename；可选查询参数 category。若 category 缺失，后端在 output_dir 下的各分类目录中查找该文件名。
  - 流程：
    1) 若提供 category，直接构造 rel_path = "{category}/{filename}"；否则在所有分类目录中查找该 filename，命中后得到 rel_path。
    2) 在 items.relative_url 精确匹配 rel_path；如未命中，尝试按 absolute_path 的末尾与 rel_path 后缀匹配以兼容历史数据。
    3) 根据 item.record_id 关联查询 records，返回 refined_positive、refined_negative、base_prompt、category_prompt 以及 meta（aspect_ratio、quality、model_name、created_at）。
    4) 返回：
       - image: { category, filename, rawUrl, thumbUrl, timestamp }
       - prompts: { positive, negative, base_prompt, category_prompt }
       - meta: { aspect_ratio, quality, model_name, created_at }
  - 兼容：保留 GET /api/images/{image_id}/details（如需要），自动判断：若 image_id 无法 decode，则按“文件名”处理并搜索。
  - 位置：在 [images_controller.py](file:///home/ubuntu/codes/z_image_make/backend/controllers/images_controller.py) 中新增路由。
  - 数据层：在 [repositories.py](file:///home/ubuntu/codes/z_image_make/backend/db/repositories.py) 为 ItemsRepo 增加“按 relative_url 查询”与“按 absolute_path 后缀匹配”的方法。
  - 错误处理：查无此文件或记录返回 404；参数缺失与异常返回 4xx/5xx，附带明确 detail。

## 加载与错误处理
- 前端：详情请求期间显示加载态；失败时 Toast 提示与重试；原图加载前以缩略图占位，加载完成后平滑替换。
- 后端：针对文件名查找失败、DB 未命中、文件确实不存在的场景分别返回合理的 HTTP 状态码与消息。

## 性能优化
- 缩略图占位 + 原图懒加载；缩放交互节流；对象自适应减少布局抖动。
- 后端优先走 items.relative_url 索引查询；仅在必要时进行 absolute_path 后缀匹配与分类目录枚举。

## 环境检查（Conda）
- 脚本：新增 scripts/env_check.sh（检查 CONDA_DEFAULT_ENV=make_image，校验 fastapi、uvicorn、pillow、sqlite3 等版本与 [requirements.txt](file:///home/ubuntu/codes/z_image_make/backend/requirements.txt) 的兼容性）。
- 启动：在 [start_backend.sh](file:///home/ubuntu/codes/z_image_make/start_backend.sh) 中增加对 env_check.sh 的调用作为预检。
- 可选：在 [health_controller.py](file:///home/ubuntu/codes/z_image_make/backend/controllers/health_controller.py) 增加 /health/env 返回环境检查摘要。

## 测试计划
- 后端：新增 backend/tests/test_image_details.py，按“文件名 + 可选分类”请求详情，验证提示词与 meta 正确；覆盖文件不存在/记录缺失等路径。
- 前端：手工测试不同尺寸图片的显示与交互；移动/桌面响应式；Chrome/Firefox 兼容；加载失败与重试路径。

## 变更点总结
- 前端：新增 ImageDetailModal、服务方法 getImageDetails({ filename, category? })；在 [App.tsx](file:///home/ubuntu/codes/z_image_make/App.tsx) 将缩略图点击行为改为打开详情。
- 后端：在 [images_controller.py](file:///home/ubuntu/codes/z_image_make/backend/controllers/images_controller.py) 增加“按文件名查询”的详情 API；扩展数据访问方法以支持 filename→record 关联。
- 脚本：新增 scripts/env_check.sh；可选扩展 /health/env。

请确认以上方案（已按“ID 即文件名”调整），我将开始实现。